(in-package #:losh)


;;;; Symbols
(defun symbolize (&rest args)
  "Slap `args` together stringishly into a symbol and intern it.

  Example:

    (symbolize 'foo :bar \"baz\")
    => 'foobarbaz

  "
  (intern (format nil "窿狎珞┅换换歪翳ㄤ彐疳蜥礤翦翎ㄣ镥蜚í痖博箝铉戾骒镝舂骢汶痖ㄤ彐躅篑踽蝈í┅ㄤ彐躅溟鲩溴箴溟鲩箫颟⒁弭躜麒弭桢囝轶弼孱禊溟鲩箝忪怡噤轹轶矧喈弪镳盹溟鲩箫颟┅ㄤ彐躅铒蝽黹磲鲠飑⑽矧磲扉圉犰麸铛礅弪忮赭邋喟犷啾磲忮┊涉圉犰轶忮赭邋囗狲犷囗轭喱翳蝈篚祠鏖祆忮铛礅弪忮赭邋喟犷啾喈涉圉犰扉弩秕趔殇镦翳蜥铉瀣轸ъ忮篝殪忮筱犰邃犷鏖祆孱躔秕趔殇翳隘蜥铉瀹ǒō鲠黹瞟ō磲黹瞟┅ㄤ彐躅戾蝠ㄦ蝻麸瞟⑻弪麸珏翳弪噫蝻磬犷圄镟怡驷泗矧囝喈物翦翳狒秕黹玷麽铘囵蝈汩箦戾蝠轭篝遽洚ǐ骝镯íō麸骝镯┅┅ㄤ彐躅痱邈轶瀛戾蝠ㄦ蝻麸瞟⑻弪麸珏翳弪噫蝻磬犷圄镟怡驷泗矧囝喱痱邈轶屐轴铋祆戾蝠滹弩铒珲狎犷翦啜戾蝠骝镯麸爱癌鏖祆蝈趱蝾屮徙綮噫蝻磬漉麸骒镝糸铉痫轭弪蝻蝮澡轶鲥蝮轱鏖祆蝈趱蝾屮徙綮噫蝻磬麒孱玳鲥囝镦喟班狒翳泔篝镦犷屮趄眭祠轲扉汜糸镱ǐíō瞟骝镯í麸┅ㄤ彐躅磲瓠蜥铉箫躜沐骝镯箫躜沐麸溴篝骝镯溴篝麸箫躜沐鲠飑⑼狃囿秕蜚瀛鲠爨骝镯翳箫躜沐蜥铉麸翳溴篝轭狒轱蜥铉瀹砒犴痨搴箫躜沐溴篝鲠祯磲瓠蜥铉爱碑卑舶爱博骄辈戾蝠溴篝骝镯溴篝麸铒蝽箫躜沐骝镯箫躜沐麸箫躜沐鲠飑┅ㄤ彐躅沆犴ㄦ蝻麸鲠祯濠⒚灬眇圉犰蹂忮赭邋噫蝻磬犷圄镟戾è磲磲骝镯麸┅黹黹骝镯麸┅ㄣ镱è鲠祯磲磲è鲠祯黹瞟黹瞟鲠祯濠┅换换裔钿镯ㄤ彐躅蜥钿镯ī⒁弭躜蜥钿镯怙镬遽町弪镳蜥钿镯博┅ㄤ彐躅蜥钿镯屐箦瘵⒁弭躜蜥钿镯屐屙孱镦囿羼喱犷麒弭桢镱麽狯衢灬忪瀹澡轶鏖祆蜗忮彐骈汩孱骘扉篝螽砒犴痨弩蜥钿镯屐（畅骄蜥钿镯屐铋飑骄铋铋戾è戾铉翳戾铉翳箦瘵┅ㄩ弪镳戾铉翳鲠祯弩铋铋飑鲠祯弩ㄥ祠箦蜥钿镯戾铉翳┅舂┅ㄤ彐躅蜥钿镯蜥铉黹磲⒁弭躜蜥钿镯铛礅弪忮赭邋坂黹钹囗狲喋ǐ黹蜥钿镯ō磲黹瞟┅ㄤ彐躅蜥钿镯蜥铉瀛屮沆躞轹黹磲⒁弭躜蜥钿镯铛礅弪忮赭邋ㄠ黹钹囗狲喋ǐ黹蜥钿镯ō磲黹暴┅ㄤ彐躅蜥钿镯狎秕钿鲠祯箴蝈徜⒁弭躜蜥钿镯铛礅弪鏖翳轭囿痱遽溧镦圉犰蹂喈蜥钿镯蜥铉ō鲠祯箴蝈徜ǐ鲠祯箴蝈徜┅ㄤ彐躅箝溴镳糸镱犰痨躞癌⒁镬箫礤溟沐砒犴痨弩ㄤ穿蝻祆变ㄤ俯蝻祆蹭ㄤ卑暴蝻祆变卑ǐㄩ翦蜥翦蝈疱狒瞟篚ū蜥钿镯箝溴螬┅痨躞┅换换契钽糸镱ㄤ彐躅牾é蝈篝骖螬⒁弭躜骢钽糸镱翳狒鏖祆牾糸痫箦翳蝈篚祠镦噫躅泗轱铙喈澡轶轶扉脲渺镪躜濮嚓貘羿情鲥骢钽糸镱啜姘姹骖┼翳轶鏖祆蝈趱蝾铄骢钽糸镱麒殂璎麒孱汜祆邃鏖翳箫礤狎珲礤铘蟋鏖祆蝈趱蝾啜扉篝ㄦ狎珞ㄦ狎珞ㄦ狎珞┅喈砒犴痨搴ㄦ躅汜祆牾＇扉篝＇＇＇博骄è博博灬礅溽é蝈篝狎珞磲疸狎蜚躜蝙＇狃痨狎珞骖螬┅换换蔑铘蝻旗秣ㄤ彐磲泸蝈沲蝮轹屐ㄢ轭溟铉怙澌怙澌⑴邈豸怙澌蝈沲蝮轹屐扉脲渺镪躜濮囔镲疣囹邈躜喈噔轭溟铉筻箬秕熹泔铘衢扉篝镦簌礅镬犷镳糸镱犰溴驷蹯鲠祯弩深噔镤喱囹邈躜鏖祆忮怙躅麸翳骢钽糸镱骘蝈沲蝌轭绠砒犴痨搴ㄤ彐躅戾铉翳箫礤扉篝蝈沲蝮轹屐è扉篝箫礤扉篝癌ㄩ铛祆扉篝蝈沲ㄣ潋扉篝ū瞟┅┅ㄦ戾è屮趄徙舡鲠ㄢ轭溟铉ㄩㄡ麸忾钿轭绌忾钿轭ㄦ轵篝忾钿轭绌┅ㄥ趄徙舡鲠ㄢ轭溟铉ㄩㄡ麸忾钿轭绌铋箦泔钿忾钿轭绌┅啜灬忮祗è蝈沲磲疸狎＇屮趄徙舡鲠忾钿轭珞棱镤┅蝈沲括磲疸狎＇屮趄徙舡鲠忾钿轭珞┅┅换换王翎糸镱ㄤ彐磲泸狃痨徙骢钽糸镱蝈篝狎珲礤铘孱鲩蝻铐孱孱雯⒄痄狒囵灬沐怡狃痨轭噫躅泗轱钹麸轸沲蝌孱鲠祯犷噌蜱蹴孱趔喈噌蜱蹴孱趔箬秕熹泔铘衢翳簌礅镬啷喱麒殂轶趄遽翦狍痨徙彖镬溴麒弪翳沲蝌孱鲠祯镦翳痨徙鏖祆忮篚怏糸趱翦轭麸翳骢钽糸镱汜祆骑屮犴痨搴狃骘＇卑骄箦翩骘ō骘卑狃骘＇卑ォ骄箦翩骘ō卑骘铹换矧殓轭犰殇遽钺礤骝镯梏麴函磲扉箴弪礤舶钡肮补狃ㄡ篌弪ㄦ轭Д狎珲礤铘螬ī⑿灬沐栾熹弪铒轭沆蹁邃轭狃磲泸骘蝽眭祠轲戾鲠祯瀛忾钿翦眇屮痱篝矧弩篝矧瀛屮痱徙沐篌屮痱ㄧ弭箦翩屮疳铙轱痨徙孱雯啜戾舄ì括磲疸狎＇扉篝翦眇屮痱螬ìㄣ狎篝矧弩ㄦ躅汜祆骢钽糸镱括篚怏糸趱翦徙沐篌屮痱Д狎珲礤铘螬┅篝矧瀛屮痱┅ㄤ彐磲泸眭戽痨徙瞟⑼蹯糸痨囵灬沐怡囝轭痨徙瀹啜狃痨徙＇瞟ㄤ彐磲泸狃痨徙骢钽糸镱⒄痄狒囵灬沐鏖翳翳蝈篚祠镦汜祆轭噫躅泗轱钹镱轸啜狃痨徙骢钽糸镱ォ换换柔箬葬忪弩ㄤ彐磲泸珏翳狍璀矧轭轸脲栳箬翎忪溴驷蹯舡骘蝽⑶弭嚯妁唰鲠祯轭噼狍璀翎忪遴轭轸獒扉轭殒铄沐篌狎涉嚯妁轶轭噼狍璀翎忪遴蝈趱蝾轸鲠祯鏖翳秕弼犰踽糸铉噤彐狨祠骘蝽狒犰飚涉嚯妁轶蜗轭噼狍璀翎忪遴弼犰踽翦噤彐狨祠骘蝽犷轭箦螋轸忮骘蝈蝈趱蝾轭轸换韵南翳轭躔戾篌箬轸豉钺礤骘翳轶镱沐镱禊脲栳箬翎忪濠鏖翳珏铙眢鲠祯骘躅洎啜眭祠轲戾鲠祯瀛忾钿ì鲠祯骘躅洎ㄧ弭栳箬脲栳箬翎忪濠ㄩ骘躅鲠祯箦翩ㄧ弭栳箬脲栳箬翎忪濠溴驷蹯舡骘蝽┅┅┅换换氧艴弩换箩箦镱翳辛尚聃艴弩翳犷塍物蝣殓┈怩忮彐邃躔扉趑戾忾麸徜换趄徙腴铉镦翳聃艴箝瀹ㄤ邈灬轫ㄩ铎轭磲脲聃艴孱聃艴溴聃艴聃艴瀛屙痿皓ㄤ彐篝蝓泗聃艴ê泔铙趄蹉麸磲脲聃艴濂┅ㄣ镱翦铘铋呼疱扉篝灬篝铋呼疱扉篝箝呼疱骈铛愆ㄤ彐躅磲脲聃艴ī磲脲聃艴濂┅ㄤ彐躅聃艴瀛屙痿瘵弪镳聃艴瀛箝瘵┅ㄤ彐躅孱聃艴ㄩ翦瘵戾è沐祆ㄣ镱轸屙铋飑┅箦翩聃艴瀛灬篝瘵ㄩ聃艴瀛屙痿瘵箦翩聃艴瀛泔铘孱趔瘵沐祆箦翩ㄣ潋聃艴瀛灬篝瘵沐祆┅┅ㄩ钽聃艴瀛箝瘵┅ㄤ彐躅溴聃艴瘵麒孱弪镳ㄤ邈聃艴瀛箝瘵┅箦翩聃艴瀛灬篝瘵铋飑痫聃艴瀛泔铘孱趔瘵┅ㄤ彐躅聃艴瀛狃疱钿飑祜镳烘矧轸屙洪烘矧箝ㄥ铖蹂蹂轸屙瘵烘轭犰禊蝈趱蝾箝濠┅换换婶弪狒ㄤ彐磲泸锃潋轹弪ㄆ弦鲠辛梢迎掀躺釉扉篝⑸翦蜥翦秭弪翳犰疳轵镦翳ㄩ钽祯溟铉灬篝骈蝮舂┊戾è膑ㄩ珏铄蜥翦х孱弪狒ф矧┅鏖翳珏铙眢ㄣ躜蝈铘飑啜痱镧鏖翳扉篝鏖翳沲蝌孱飑ì膑鲠铄ㄣ镱è铛祆沲蝌孱舂翦蝽轭狒濠è铛祆ㄣ潋沲蝌孱舂痱镧ㄣ镱ㄦ轵篝沲蝌孱舂ㄣ狎飑箦翩沲蝌孱铋飑┅痱镧ㄣ镱ㄦ轵篝沲蝌孱舂箦泔钿沲蝌孱舂箦翩沲蝌孱ㄣ潋沲蝌孱舂┅┅┅┅ㄤ彐磲泸锃沆狨箦林乓燎晌屮痱镳糸镱犰晌韵鲠颟鏖翳珏铙眢ㄣ秕铘戾è狯弪徵矧鲠ㄧ孱簌⑨鲥蜥珏┅┅啜痱镧ㄦ矧狯弪徵烘轵篝屮痱换泔铘轭躏躞禊蝈泔眇豸翳蝓铑轭狯弪徵轭篝遽镦脲屦轭换蝓铑轭麸翎麸狯镩忾珙蹴麒孱痫篌殁戾呼桢ǒǐí狯弪徵泔躅舂屮痱ū泔躅舂┅ㄦ矧泔躅烘蝻暴麒孱铛祆鲠颟换麸滹栳钿戾翳轶忮趑弪啜骈钺祆蝈趱蝾狯弪徵濠┅┅┅ㄤ彐磲泸锃沆狨箦ㄔ赏晌糸礤豉疱镳糸镱犰由蚊怒釉烈原晌韵鲠信噎稍乓猎上苇晌韵疱颟戾è糸黹铉骢钽糸镱ㄥ汜箦糸礤豉疱è蝈犰糸礤＇珏舡轭翦蝾犰蝈犰糸礤è蝓瞽糸礤＇珏舡轭翦蝾犰蝓瞽糸礤┅箝钽矧鲠ㄧ孱簌愆┅鏖翳珏铙眢篝狎舡糸礤沲蝌孱舡糸礤痱弼轱躞糸礤啜痱镧鏖翳篝狎舡糸礤ㄦ躅汜祆糸黹铉骢钽糸镱┅ㄦ矧沲蝌孱舡糸礤ㄦ躅汜祆糸黹铉骢钽糸镱┅ㄦ矧痱弼轱躞糸礤吼蝈鲩秕沲蝌孱舡糸礤洪铋糸犰禊篝狎舡糸礤ㄦ矧箝钽ō沲蝌孱舡糸礤篝狎舡糸礤┅麒孱疱啜骘疱ō沲蝌孱舡糸礤痱弼轱躞糸礤┅麒孱ㄡ钿铛祆鲠颟铛祆疱颟啜骈钺祆蝈趱蝾箝钽濠┅┅┅ㄤ彐磲泸锃潋轹弪ㄆ弦鲠晌躺釉扉篝螬戾è膑ㄩ珏铄蜥翦х孱弪狒ф矧┅鏖翳珏铙眢扉篝啜痱镧ㄧ孱弪狒扉篝洪蝈盹鲥铋扉篝漓轶趔┅ì膑鲠铄痱镧麒孱铛祆扉篝铄扉篝┅痫扉篝┅┅┅ㄤ彐躅箦癍滹铄箦戾殇ㄩ殇殇戾瞟铛祆箦瘵┅ㄤ彐磲泸锃潋轹弪ㄆ弦鲠晌优颜盼门箦耋戾è膑ㄩ珏铄蜥翦х孱弪狒ф矧┅鏖翳珏铙眢箦戾殇啜痱镧鏖翳戾铋飑鏖翳殇铋飑ㄧ孱弪狒箦洪蝈盹鲥殒＇屙痿扉篝荔羼螬┅ì膑鲠铄痱镧麒孱箦癍滹铄箦戾殇ㄥ豉疱汜箦铄箦瘵ㄣ镱箦翩戾铋殇铋飑箦聃孱沐箦翩戾戾铉翳箦瘵殇癌┅ㄩ殇痱镧ㄥ祠箦殇ㄩ钽殇┅痫箦瘵┅┅┅换换柔箬渝趔ㄤ彐沆狍栳箬箦īè溽翎洪铋翎蜱轰狒岍┅ㄤ彐躅磲脲箦é脲翦篝＇羼飑ㄩ铋糸犰溽翎铋飑戾è箦磲脲轭篝犷沐ц狍璀箦轰狒磲脲栳箬翎忪呼弩翦篝┅┅磲疸狎ㄣ躜蝙＇箦舡徜箦舂轭轸獒飙溽翎箦舂ㄤ彐躅箦舡泔铘衢铙箦鲠祯濠铘璀鲠祯ㄧ弭栳箬鲠祯箪雉鲠祯箦т狒岍┅ㄤ彐躅箦舡屙痿箦舂弪镳ㄨ狍璀翎忪瀛泔躅箪雉鲠祯箦т狒岍┅ㄤ彐躅箦舡徜箦鲠祯濠箦翩ㄧ弭栳箬鲠祯箪雉鲠祯箦т狒岍舂鲠祯濠ㄤ彐躅箦舡徜洵犰箦箦瘵磲铋ㄣ躜蝙＇箦舡徜箦舂箦瘵ㄤ彐躅箦舡蝈盹鲥箦鲠祯濠蝈龛狍鲠祯箪雉鲠祯箦т狒岍鲠祯濠ㄤ彐躅箦舡蝈盹鲥犰箦箦瘵磲铋ㄣ躜蝙＇箦舡蝈盹鲥箦舂箦瘵ㄤ彐躅箦舡沆遽箦舂ㄣ祢栳箬箪雉鲠祯箦т狒岍箦舂ㄤ彐躅箦舡蜥钿镯箦舂ㄩ箦舡屙痿箦舂鲠祯弩铋铋飑祜镳瑚轸溽翎箪雉鲠祯箦т狒岍瑚轸翎蜱弭蜥钿镯ㄨ狍璀翎忪瀛泔躅溽翎┅烘矧烘蝻烘矧衡彘铉呼桢鸿狍璀脲猴溽翎瑚桢翎蜱弭轰蝈趱蝾鲠祯弩舂┅┅ㄤ彐躅箦舡痫箦舂眭祠轲戾鲠祯瀛忾钿鲠骘躅洎箦舡蜥钿镯箦舂ㄩ骘躅痱镧箦舡蝈盹鲥箦鲠飑鲠祯弩鲠舂鲠祯弩铋铋飑┅ㄤ彐礤翳镤痱轭舡镡赍泗è箦栳箬箦舂篝蝈犴痱轭舡躅蝈徜徕戾镡赍泗箦篝蝈犴呼疱舂ㄦ矧磲篝蝈犴誉"
            (iterate (for (key nil) :in-hashtable (slot-value set 'data))
                     (collect key)))))


;;;; Debugging & Logging
(defun pr (&rest args)
  (format t "誉%" args)
  (finish-output)
  (values))

(defun bits (n size)
  ;; http://blog.chaitanyagupta.com/2013/10/print-bit-representation-of-signed.html
  (format t (format nil "~D,'0B" size) (ldb (byte size 0) n))
  (values))


;;;; File IO
(defun slurp (path)
  "Sucks up an entire file from PATH into a freshly-allocated string,
   returning two values: the string and the number of bytes read."
  (with-open-file (s path)
    (let* ((len (file-length s))
           (data (make-string len)))
      (values data (read-sequence data s)))))

(defun spit (path str)
  "Spit the string into a file at the given path."
  (with-open-file (s path :direction :output :if-exists :supersede)
    (format s "A" str)))


;;;; dlambda
;;; From Let Over Lambda.
(defmacro dlambda (&rest clauses)
  (with-gensyms (message arguments)
    (flet ((parse-clause (clause)
             (destructuring-bind (key arglist &rest body)
                 clause
               `(,key (apply (lambda ,arglist ,@body) ,arguments)))))
      `(lambda (,message &rest ,arguments)
        (ecase ,message
          ,@(mapcar #'parse-clause clauses))))))
